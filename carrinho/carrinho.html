<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Cadastro de Funcionários</title>
</head>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<body onload=" exibirFuncionarios(carregarFuncionariosDoLocalStorage())">
  <form>
    <fieldset>
      <legend>Cadastro de Funcionário</legend>
      <label for="nome">Nome:</label> <input type="text" id="nome"><br>
      <label for="datanasc">Data de Nascimento:</label> <input type="text" id="datanasc" placeholder="dd/mm/aaaa"><br>
      <label for="dataadmissao">Data de Admissão:</label> <input type="text" placeholder="dd/mm/aaaa"
        id="dataadmissao"><br>
      <input type="button" id="btcadastrar" onclick="validarFormulario()" value="Cadastrar">
    </fieldset>
  </form>
  <table id="funcionarios">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Data de Nascimento</th>
        <th>Data de Admissão</th>
        <th>Excluir</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
  <style>
    body {
      font-family: Arial;
    }

    label {
      display: inline-block;
      width: 150px;
      margin: 2px;
    }

    fieldset {
      display: inline-block;
    }

    th {
      background-color: black;
      color: white;
    }

    #datanasc,
    #dataadmissao {
      width: 10em;
    }

    td:last-child,
    button {
      border: none;
      text-align: center;
      color: red;
      cursor: pointer;
    }
  </style>

  <script>
    class Pessoa {
      constructor(nome, dataNascimento) {
        this.nome = nome;
        this.dataNascimento = new Date(dataNascimento);
      }

      getIdade() {
        const hoje = new Date();
        let idade = hoje.getFullYear() - this.dataNascimento.getFullYear();
        const mesAtual = hoje.getMonth();
        const mesNascimento = this.dataNascimento.getMonth();
        if (mesAtual < mesNascimento || (mesAtual === mesNascimento && hoje.getDate() < this.dataNascimento.getDate())) {
          idade--;
        }
        return idade;
      }
    }

    class Funcionario extends Pessoa {
      constructor(nome, dataNascimento, dataAdmissao) {
        super(nome, dataNascimento);
        this.dataAdmissao = new Date(dataAdmissao);
      }

      getTempoServico() {
        const hoje = new Date();
        let idade = hoje.getFullYear() - this.dataAdmissao.getFullYear();
        const mesAtual = hoje.getMonth();
        const mesNascimento = this.dataAdmissao.getMonth();
        if (mesAtual < mesNascimento || (mesAtual === mesNascimento && hoje.getDate() < this.dataAdmissao.getDate())) {
          idade--;
        }
        return idade;
      }
    }

    function carregarFuncionariosDoLocalStorage() {
      const funcionariosString = localStorage.getItem("funcionarios");
      if (funcionariosString) {
        const funcionariosJson = JSON.parse(funcionariosString);
        const funcionarios = funcionariosJson.map((funcionario) => new Funcionario(funcionario.nome, funcionario.dataNascimento, funcionario.dataAdmissao));
        return funcionarios;
      } else {
        return [];
      }
    }

    function validarFormulario() {
      const regex = /^\d{2}\/\d{2}\/\d{4}$/;
      const dataNascimento = $("#datanasc");
      const dataAdmissao = $("#dataadmissao");

      if (!regex.test(dataNascimento.val())) {
        alert("Data Nascimento inválida. Utilize o formato dd/mm/aaaa.");
      } else if (!regex.test(dataAdmissao.val())) {
        alert("Data Admissão inválida. Utilize o formato dd/mm/aaaa.");
      } else {
        cadastrarFuncionario();
      }
    }

    function cadastrarFuncionario() {
      const nome = document.getElementById("nome").value;
      const dataNascimento = $("#datanasc").val();
      const dataAdmissao = $("#dataadmissao").val();
      const funcionario = new Funcionario(nome, dataNascimento, dataAdmissao);
      const funcionarios = carregarFuncionariosDoLocalStorage();
      funcionarios.push(funcionario);

      salvarFuncionarios(funcionarios);
      exibirFuncionarios(carregarFuncionariosDoLocalStorage());
    }

    function exibirFuncionarios(funcionarios) {
      const tabela = $("#funcionarios");
      const tbody = tabela.find("tbody");
      tbody.empty();

      funcionarios.forEach((funcionario) => {
        const tr = $("<tr></tr>");

        const td_nome = $("<td></td>").text(funcionario.nome);
        tr.append(td_nome);

        const input_nascimento = $("<input>").val(funcionario.dataNascimento.toLocaleDateString('pt-BR'));
        const td_nascimento = $("<td></td>");
        input_nascimento.on("change", function () {
          const novaDataNascimento = $(this).val();
          atualizarDataNascimento(funcionario.nome, novaDataNascimento);
        });
        td_nascimento.append(input_nascimento);
        td_nascimento.append("(" + funcionario.getIdade() + " anos)");
        tr.append(td_nascimento);

        const input_admissao = $("<input>").val(funcionario.dataAdmissao.toLocaleDateString('pt-BR'));
        const td_admissao = $("<td></td>");
        input_admissao.on("change", function () {
          const novaDataAdmissao = $(this).val();
          atualizarDataAdmissao(funcionario.nome, novaDataAdmissao);
        });
        td_admissao.append(input_admissao);
        td_admissao.append("(" + funcionario.getTempoServico() + " anos)");
        tr.append(td_admissao);

        const td_excluir = $("<td></td>");
        const btn_excluir = $("<button>X</button>");

        btn_excluir.on("click", function () {
          excluirFuncionarioDoLocalStorage(funcionario.nome);
          tr.remove();
        });

        td_excluir.append(btn_excluir);
        tr.append(td_excluir);

        tbody.append(tr);
      });
    }

    function excluirFuncionarioDoLocalStorage(nomeFuncionario) {
      const funcionarios = carregarFuncionariosDoLocalStorage();
      const index = funcionarios.findIndex(funcionario => funcionario.nome === nomeFuncionario);
      funcionarios.splice(index, 1);
      salvarFuncionarios(funcionarios);
    }

    function atualizarDataNascimento(nomeFuncionario, novaData) {
      const funcionarios = carregarFuncionariosDoLocalStorage();
      const index = funcionarios.findIndex(funcionario => funcionario.nome === nomeFuncionario);
      funcionarios[index].dataNascimento = novaData;
      salvarFuncionarios(funcionarios);
      location.reload();
    }

    function atualizarDataAdmissao(nomeFuncionario, novaData) {
      const funcionarios = carregarFuncionariosDoLocalStorage();
      const index = funcionarios.findIndex(funcionario => funcionario.nome === nomeFuncionario);
      funcionarios[index].dataAdmissao = novaData;
      salvarFuncionarios(funcionarios);
      location.reload();
    }

    function salvarFuncionarios(funcionarios) {
      localStorage.setItem("funcionarios", JSON.stringify(funcionarios));
    }

  </script>
</body>

</html>